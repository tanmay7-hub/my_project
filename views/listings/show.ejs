 <%=layout("layouts/boilerplate.ejs")%>
 <script>
  const mapToken="<%=process.env.MAP_TOKEN%>";
  const coordinates =<%-JSON.stringify(listingDetails.geometry.coordinates)%>;
 </script>
 
  <!-- start -->
  
  <div class="show-card row mt-3" >
          <div class="col-8 offset-3">
              <h3><%=listingDetails.title%></h3>
          </div>
          <div class="card col-6 offset-3 listing-card">
              <img src="<%=listingDetails.image.url%>" class="card-img-top show-img" alt="listing_image">
              <div class="card-body">
                <p class="card-text">
                  <p><strong>Owned by: <%=listingDetails.owner.username%></strong> </p>
                  <b><%=listingDetails.title%></b> <br>
                  <%=listingDetails.description%> <br>
                  &#8377;<%=listingDetails.price.toLocaleString("en-IN")%> <br>
                  <%=listingDetails.location%> <br>
                  <%=listingDetails.country%> <br>
  
                 </p>
               </div>

          <% if (!currUser) { %>
                 <a href="/login" class="btn btn-log">
                    <i class="fa-solid fa-calendar-check"></i> Book Now
                  </a>
           <% } else { %>
              <button type="button" class="btn btn-log" data-bs-toggle="modal" data-bs-target="#bookingModal">
               <i class="fa-solid fa-calendar-check"></i> Book Now
              </button>
           <% } %>
         <%- include("../partials/bookingModal", { listing: listingDetails }) %>
          </div>

          <!-- payments -->
           <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
            <script>
                  document.getElementById("bookingForm").onsubmit = async function (e) {
                  e.preventDefault();

                  const formData = new FormData(this);
                  const data = Object.fromEntries(formData);

                // Calculate days stayed
                 const days = (new Date(data.checkOut) - new Date(data.checkIn)) / (1000 * 60 * 60 * 24);
                 const totalAmount = days *<%=listingDetails.price %> * 100; // in paise for Razorpay
                 
               // Set hidden totalAmount field
                document.getElementById("finalAmount").value = totalAmount/100; // INR for DB

                const res = await fetch("/create-order", {
                             method: "POST",
                             headers: { "Content-Type": "application/json" },
                             body: JSON.stringify({
                             listingId: data.listingId,
                             checkIn: data.checkIn,
                             checkOut: data.checkOut,
                             amount: totalAmount 
                            })
                  });

                const order = await res.json();

                const options = {
                             key: "<%= process.env.RAZORPAY_KEY_ID %>",
                             amount: order.amount,
                             currency: order.currency,
                             name: "Booking Payment",
                             description: "Payment for your stay",
                             order_id: order.id,
                            handler: async function (response) {
                            const saveRes = await fetch("/save-booking", {
                                                 method: "POST",
                                                 headers: { "Content-Type": "application/json" },
                                                 body: JSON.stringify({
                                                 listingId: data.listingId,
                                                 checkIn: data.checkIn,
                                                 checkOut: data.checkOut,
                                                 totalAmount: totalAmount / 100, // INR
                                                 paymentId: response.razorpay_payment_id
                                            })
                                             });
                             const bookingData = await saveRes.json();
                             window.location.href = `/booking-confirmation/${bookingData.bookingId}`;
                              }
                              ,
                          prefill: { name: data.name },
                          theme: { color: "#F37254" }
                        };
                          const rzp = new Razorpay(options);
                         rzp.open();
                        };
              </script>
           

 
    <!-- Edit and delete -->
      <% if( currUser &&listingDetails.owner._id.equals(currUser._id)){ %>
      <div class="btns">
            <a href="/listing/<%=listingDetails._id%>/edit" class="btn btn-dark col-1 offset-3 edit-btn">Edit </a>
     
            <form method="POST" action="/listing/<%=listingDetails._id%>?_method=DELETE">
                  <button class="btn btn-dark offset-5">Delete</button>
            </form>
      </div>
      <% } %>
    
      <div class="col-8 offset-3 mb-3">  
      <hr>
       <% if(currUser){%>
        <h4>Leave a review </h4>
          <form action="/listings/<%=listingDetails._id%>/reviews" method="POST" novalidate class="needs-validation">
            
              <div class="mb-3 mt-3"> 
                 <label for="rating" class="form-label"><strong>Rating</strong></label>
            <fieldset class="starability-slot">
           <input type="radio" id="no-rate" class="input-no-rate" name="review[rating]"  value="1" checked aria-label="No rating." />
           <input type="radio" id="first-rate1" name="review[rating]"  value="1" />
           <label for="first-rate1" title="Terrible">1 star</label>
           <input type="radio" id="first-rate2" name="review[rating]"  value="2" />
           <label for="first-rate2" title="Not good">2 stars</label>
           <input type="radio" id="first-rate3" name="review[rating]"  value="3" />
           <label for="first-rate3" title="Average">3 stars</label>
           <input type="radio" id="first-rate4" name="review[rating]"  value="4" />
           <label for="first-rate4" title="Very good">4 stars</label>
           <input type="radio" id="first-rate5" name="review[rating]"  value="5" />
           <label for="first-rate5" title="Amazing">5 stars</label>
           </fieldset>
           </div>
              <div class="mt-3">
                <label for="comment" class="form-label">Comments</label>
                <textarea required class="form-control" name="review[comment]" id="comment" cols="20" rows="5"></textarea>
                <div class="invalid-feedback">Please add some comments.</div>
              </div>
               
              <button class="btn btn-outline-dark mt-3">Submit</button>
          </form>
            <hr>
        <%}%>
         <!--review  -->
        <% if(listingDetails.reviews.length > 0){ %>
            <p><b> Reviews</b></p>
             <div class="row">
                <% for( review of listingDetails.reviews) { %>
                    <div class="card col-5 mb-3 ms-3  ">
                      <div class="card-body">
                       <h5 class="card-title mt-2">@<%=review.author.username%></h5>
                        <p class="starability-result" data-rating="<%=review.rating%>"> Rated: 3 stars </p>
                        <p class="card-text"><%=review.comment%></p>      
                        <form method="POST" action="/listings/<%=listingDetails._id%>/reviews/<%=review._id%>?_method=DELETE">
                           <button class="btn btn-sm btn-dark mb-3">Delete</button>
                        </form>
                    </div>
                <% }%>
            </div>
      </div>
      <% } %>
       <h3>Where you'll be:</h3>
      <div class="cols-10 mb-4"id="map">
         
      </div>
   </div>


   
  <!-- end -->
    <script src="/js/map.js"></script>
  
